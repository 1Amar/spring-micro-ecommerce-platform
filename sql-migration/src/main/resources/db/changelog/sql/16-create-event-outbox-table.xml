<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.20.xsd">

    <changeSet id="16-create-event-outbox-table" author="system">
        <comment>Create event_outbox table for transactional outbox pattern</comment>
        
        <sql>
            -- Create event_outbox table in order_service schema
            CREATE TABLE IF NOT EXISTS order_service.event_outbox (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                aggregate_id VARCHAR(255) NOT NULL,
                aggregate_type VARCHAR(100) NOT NULL,
                event_type VARCHAR(100) NOT NULL,
                event_data TEXT NOT NULL,
                topic VARCHAR(255) NOT NULL,
                kafka_key VARCHAR(255),
                processed BOOLEAN NOT NULL DEFAULT FALSE,
                created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
                processed_at TIMESTAMP,
                retry_count INTEGER NOT NULL DEFAULT 0,
                last_error TEXT
            );
            
            -- Create indexes for efficient querying
            CREATE INDEX IF NOT EXISTS idx_event_outbox_processed ON order_service.event_outbox(processed);
            CREATE INDEX IF NOT EXISTS idx_event_outbox_created_at ON order_service.event_outbox(created_at);
            CREATE INDEX IF NOT EXISTS idx_event_outbox_aggregate ON order_service.event_outbox(aggregate_id, aggregate_type);
            CREATE INDEX IF NOT EXISTS idx_event_outbox_retry ON order_service.event_outbox(processed, retry_count);
            
            -- Create index for cleanup queries
            CREATE INDEX IF NOT EXISTS idx_event_outbox_cleanup ON order_service.event_outbox(processed, processed_at);
        </sql>
        
        <rollback>
            DROP INDEX IF EXISTS order_service.idx_event_outbox_cleanup;
            DROP INDEX IF EXISTS order_service.idx_event_outbox_retry;
            DROP INDEX IF EXISTS order_service.idx_event_outbox_aggregate;
            DROP INDEX IF EXISTS order_service.idx_event_outbox_created_at;
            DROP INDEX IF EXISTS order_service.idx_event_outbox_processed;
            DROP TABLE IF EXISTS order_service.event_outbox;
        </rollback>
    </changeSet>

</databaseChangeLog>