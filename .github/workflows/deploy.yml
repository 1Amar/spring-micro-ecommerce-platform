name: Deploy to AWS

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 13.235.42.64 >> ~/.ssh/known_hosts
          ssh-keyscan -H 3.111.144.135 >> ~/.ssh/known_hosts
          
      - name: Deploy to servers
        run: |
          # Deploy to Gateway Server
          ssh -i ~/.ssh/id_rsa ec2-user@13.235.42.64 << 'EOF'
            cd /opt/ecommerce
            git pull origin main
            sudo docker-compose -f Docker/docker-compose.yml up -d postgres keycloak redis prometheus grafana jaeger
            sudo docker ps
          EOF
          
          # Deploy to Services Server  
          ssh -i ~/.ssh/id_rsa ec2-user@3.111.144.135 << 'EOF'
            cd /opt/ecommerce
            git pull origin main
            echo "Services deployment ready"
          EOF